var OpenTokAdapter=function(){"use strict";function n(n){this.session=n,this.session.on({connectionDestroyed:function(n){this.trigger("client_left",n.connection.connectionId)},connectionCreated:function(n){n.connection.data&&n.connection.data.name&&this.trigger("set_name",n.connection.connectionId,n.connection.data.name)},"signal:opentok-editor-operation":function(n){if(n.from.connectionId!==this.session.connection.connectionId){var o=JSON.parse(n.data);this.trigger("operation",o.operation),this.trigger("cursor",n.from.connectionId,o.cursor)}},"signal:opentok-editor-cursor":function(n){if(n.from.connectionId!==this.session.connection.connectionId){var o=JSON.parse(n.data);this.trigger("cursor",n.from.connectionId,o)}}},this)}return n.prototype.sendOperation=function(n,o,t){this.session.signal({type:"opentok-editor-operation",data:JSON.stringify({revision:n,operation:o,cursor:t})},function(n){n||this.trigger("ack")}.bind(this))},n.prototype.sendCursor=function(n){this.session.signal({type:"cursor",data:JSON.stringify(n)})},n.prototype.registerCallbacks=function(n){this.callbacks=n},n.prototype.trigger=function(n){var o=Array.prototype.slice.call(arguments,1),t=this.callbacks&&this.callbacks[n];t&&t.apply(this,o)},n}(),OpenTokEditor=angular.module("opentok-editor",["opentok"]).directive("otEditor",["OTSession","$window",function(n){return{restrict:"E",template:'<div ng-if="connecting">Connecting...</div><div ng-show="!connecting"><div class="opentok-editor"></div></div>',link:function(o,t,i){var e,c,r,s=t.context.querySelector("div.opentok-editor"),a=n.session;o.connecting=!0;var d=function(n,t){c||(c=new ot.EditorClient(n,t,new OpenTokAdapter(a),new ot.CodeMirrorAdapter(e))),o.$apply(function(){o.connecting=!1})},p=function(){e=CodeMirror(s,i),r&&e.setValue(r.str),setTimeout(function(){d(0,[])},2e3)};a.on({sessionConnected:function(){p()},connectionCreated:function(n){c&&n.connection.connectionId!==a.connection.connectionId&&a.signal({type:"opentok-editor-doc",to:n.connection,data:JSON.stringify({revision:c.revision,clients:c.clients,str:e.getValue()})})},"signal:opentok-editor-doc":function(n){r=JSON.parse(n.data),e&&e.setValue(r.str),d(r.revision,r.clients)}}),a.isConnected()&&p()}}}]);